# Jetson Nano Run Step Tool (JetRunStep) 

## **OverView**
---
Jetson Nano Run Step Tool </br>
 Create 2021.09</br>
 Author  : GENROKU@Karakuri-musha</br>
 License : See the license file for the license.</br>
 Python ver : Python 3.6.9 (conda)</br>
 Hardware : Ubuntu 18.04.5 LTS (Jetson Nano Developer Kit) </br>
 
このツールはJetson Nano Developer KitのOSであるUbuntu18.04で、パッケージや環境設定のコマンドを順次自動実行できる機能と、インストール後のパッケージバージョンの更新状態を取得してXML構造で履歴管理する機能を、Pythonで実装したものです。</br>

This tool is Ubuntu 18.04, which is the OS of Jetson Nano Developer Kit, and has a function to automatically execute package and environment setting commands in sequence and a function to acquire the update status of the package version after installation and manage the history with XML structure. , Implemented in Python.</br>
 </br>

以下のブログでこのツールを紹介しています。参考にしてください。（日本語）</br>
[【Jetson Nano】自分の記憶が信じられない貴方へ。。（セットアップ自動化）</br>https://karakuri-musha.com/inside-technology/jetson-pkg-management-tool/](https://karakuri-musha.com/inside-technology/jetson-pkg-management-tool/)

</br>

## **Tool file structure**
---
ツールのファイル構成は次の通りです。</br>
Target OS：Ubuntu18.04 LTS (Jetson Nano) 
</br>

|ファイル名  |形式  |説明  |
|---------|---------|---------|
|JetRunStep.py|Python3(.py)| ツール 本体です。Jetson Nano Developper Kit環境で実行してください。</br>The main body of the tool. Run it in the Jetson Nano Developper Kit environment.|
|JetRunStep_func.py|Python3(.py)| ツールで使用する独自関数を定義したファイルです。</br>This is a file that defines unique functions used by the tool.|
|JetRunStepSetting.json|json(.json)| ツールの動作設定用ファイルです。</br>This is a file for setting the operation of the tool.|
|Jetson_to_do_001.json|json(.json)| ツールで順次実行するシェルコマンドを定義したファイルです。ファイル名はなんでもOKです。</br>This file defines shell commands that are executed sequentially by the tool. Any file name is OK.|
|Common|Directory| ファイル操作や、Json読み込み、サブプロセス実行などよく使う処理を収録したディレクトリです。</br>This directory contains frequently used processes such as file operations, Json reading, and subprocess execution.|
|env_trace|Directory| ツール実行結果出力用ディレクトリです。ツールで生成したXMLファイルや参照用のHTMLファイルを格納j。「Env_trace.xml」ファイルは管理用のXMLファイルです。「Env_browse.html」ファイルは参照用のHTMLファイルです。※「js」にはHTMLを見やすくするCSSやJavaScriptが格納されています。</br>This is the directory for outputting tool execution results. Stores the XML file generated by the tool and the HTML file for reference j. The "Env_trace.xml" file is an XML file for management. The "Env_browse.html" file is an HTML file for reference. * CSS and JavaScript that make HTML easier to read are stored in "js".|
|Log|Directory|ツール実行ログの出力先フォルダです。ツール実行毎にログファイルが格納されます。初期設定はログ最大10ファイルが上限で、古いものから削除されます。</br>This is the output destination folder for the tool execution log. A log file is stored each time the tool is executed. The default setting is a maximum of 10 log files, and the oldest ones are deleted.|
</br>


## **Run-time option specification**
---
ツール実行時に指定できるオプションは次の通りです。

[Execution example(for cmd)]</br>
`pyhon3 JetRunStep.py -i <'shell command'> -a <shell command file> -j JetRunStepSetting.json -v <reference XML file name>`  

|option|Description|
|---------|---------|
| -i [Install] | 実行するコマンドを「''」で囲って指定（必須：-a と排他）</br> Specify the command to be executed by enclosing it in "''" (required: exclusive with -a)|
| -a [AutoInstall] | 実行コマンドを収録したファイル名を指定（必須：-i と排他）</br> Specify the file name that contains the execution command (required: exclusive with -i)|
| -j [json] | 動作設定用ファイル名を指定します。（任意）</br> Specify the file name for the operation settings. (Any) |
| -v [XMLViewFile] |参照用（インデント付き）XMLファイル名を指定します。ファイルはツール実行フォルダに作成されます。（任意）</br> Specifies the reference (indented) XML file name. The file is created in the tool execution folder. (Any) |

 </br>
 </br>

## **Operation setting (entry in json file)**
---
動作設定ファイル（JetRunStepSetting.json）は次のような構成になっています。

[JetRunStepSetting.json]</br>
`{
    "run_env"               : "2",
    "env_trace_interval"    : "All",
    "env_trace_output_dir"  : "./env_trace",
    "env_trace_xml_file"    : "Env_trace.xml",
    "env_browse_file"       : "Env_browse.html",
    "max_log_cnt"           : "10",
    "csv_output"            : "1"
}`

|item|default|Description|
|---------|---------|---------|
|run_env| *2* | 動作環境の指定です。Jetson Nanoは「2」です。この設定は今後の拡張用です。変更の必要はありません。</br> It is the specification of the operating environment. Jetson Nano is "2". This setting is for future expansion. No need to change.|
|env_trace_interval| *All* | 環境更新状況の確認間隔を指定します。「All」は全てのシェルコマンド実行後に確認を行い、「Once」はツール実行につき一回確認を行います。コマンド毎に実行する時間がない場合は「Once」に設定します。</br>Specify the check interval for the environment update status. "All" confirms after executing all shell commands, and "Once" confirms once for each tool execution. If you do not have time to execute each command, set it to "Once".|
|env_trace_output_dir| *./env_trace* | 処理結果の出力先パスを指定します。ツール実行ディレクトリからの相対パスで指定します。</br> Specify the output destination path of the processing result. Specify the path relative to the tool execution directory.|
|env_trace_xml_file| *Env_trace.xml* |更新履歴管理用XMLファイル名を指定します。</br> Specify the XML file name for update history management.|
|env_browse_file| *Env_browse.html* |更新履歴の参照用HTMLファイル名を指定します。</br>Specify the HTML file name for referencing the update history.|
|max_log_cnt| *10* |処理結果ログの最大保存ファイル数を指定します。</br>Specify the maximum number of files to save the processing result log.|
</br>
 </br> </br>

## **How to Log management**
---
本ツール実行時には、ツール格納先フォルダ配下に「Log」ディレクトリが作成され、本ツール実行時のログが格納されます。</br>
ログはツールの実行毎に出力されるため、動作設定ファイル内でログの最大保存数を設定することを推奨します。</br>
ツール実行時に最大補完数と同数のログがある場合に更新日付の古いモノから削除されます。

When this tool is executed, a "Log" directory is created under the tool storage folder, and the log when this tool is executed is stored. </br>
Since the log is output each time the tool is executed, it is recommended to set the maximum number of logs to be saved in the operation setting file. </br>
If there are as many logs as the maximum number of completions when the tool is executed, the ones with the oldest update date will be deleted.


 </br>
 </br> 

## **How to use**
### **[1] How to install and run**
---
１．ツール配置用のディレクトリに移動します。</br>
```
cd <Tool Save Directory>
```
２．ディレクトリにツールをコピーします。コピー後ツールディレクトリに移動します。</br>移動後に一度実行して管理情報を作成します。</br>
```
sudo git clone https://github.com/karakuri-musha/JetRunStep.git
cd JetRunStep
pyhon3 JetRunStep.py -i 'ls -l'
```
３-１．シェルコマンドを単体で実行する場合</br>
　　　（例：Python3-pipをインストールする場合は以下のコマンドになります。）</br>
　　　　※参照用XMLファイルを作る場合は例えば、「 -v Env_brows.xml 」を追加します。
```
pyhon3 JetRunStep.py -i 'sudo apt install python3-pip'
```
３-２．jsonファイルにシェルコマンドを複数記載して順次、自動実行させる場合</br>
　　　（例：Jetson_to_do_001.jsonをコマンドファイルとして使用する場合は以下のコマンドになります。）</br>
　　　　※参照用XMLファイルを作る場合は例えば、「 -v Env_brows.xml 」を追加します。
```
pyhon3 JetRunStep.py -a Jetson_to_do_001.json
```
※Jetson_to_do_001.jsonファイルの記載方法は、次の章で記載します。


４．ツール実行結果として、ツール実行ディレクトリに「Log」ディレクトリが作成されます。 </br>
　　フォルダ内に実行時のログが保存されることを確認してください。


**【ログ内容：例　初回実行時】**
```
2021-10-01 11:45:14,137@ Common.kmg_common [INFO] check_system_env: System Enviroment Check Process Begin
2021-10-01 11:45:14,148@ Common.kmg_common [INFO] check_system_env: The operating system is [Linux]
2021-10-01 11:45:14,154@ Common.kmg_common [INFO] check_system_env: The model name is [NVIDIA Jetson Nano Developer Kit]
2021-10-01 11:45:14,160@ Common.kmg_common [INFO] <module>: delete log file : ./Log/log20211001110047.log
2021-10-01 11:45:14,161@ Common.kmg_common [INFO] <module>: Start the Jetson Nano Run Setup Tool (JetRunStep) .
2021-10-01 11:45:14,169@ Common.kmg_common [INFO] run_one_cmd: total 584

-- シェルコマンド実行時のPIPEの情報が記載される --

2021-10-01 11:43:49,795@ Common.kmg_common [INFO] create_xml: The environment configuration check (init) will start.
2021-10-01 11:43:50,062@ Common.kmg_common [INFO] create_xml: The environment configuration check (init) is complete.
2021-10-01 11:43:50,065@ Common.kmg_common [INFO] run_one_cmd: Since this tool was executed for the first time, an administrative file (Env_trace.xml) was created.
2021-10-01 11:45:30,093@ Common.kmg_common [INFO] create_xml_view: Start generating XML file for reference.
2021-10-01 11:45:31,288@ Common.kmg_common [INFO] update_file_full: ---- Update file ----
2021-10-01 11:45:31,290@ Common.kmg_common [INFO] update_file_full: ---- Success Update file ----
2021-10-01 11:45:31,291@ Common.kmg_common [INFO] create_xml_view: Complete generating XML file for reference.
2021-10-01 11:45:31,294@ Common.kmg_common [INFO] create_html: Start HTML file generation.
2021-10-01 11:45:31,359@ Common.kmg_common [INFO] create_html: End HTML file generation.
2021-10-01 11:45:31,365@ Common.kmg_common [INFO] update_file_full: ---- Update file ----
2021-10-01 11:45:31,368@ Common.kmg_common [INFO] update_file_full: ---- Success Update file ----
```

**【ログ内容：例　2回目以降】**
```
2021-10-01 11:45:14,137@ Common.kmg_common [INFO] check_system_env: System Enviroment Check Process Begin
2021-10-01 11:45:14,148@ Common.kmg_common [INFO] check_system_env: The operating system is [Linux]
2021-10-01 11:45:14,154@ Common.kmg_common [INFO] check_system_env: The model name is [NVIDIA Jetson Nano Developer Kit]
2021-10-01 11:45:14,160@ Common.kmg_common [INFO] <module>: delete log file : ./Log/log20211001110047.log
2021-10-01 11:45:14,161@ Common.kmg_common [INFO] <module>: Start the Jetson Nano Run Setup Tool (JetRunStep) .
2021-10-01 11:45:14,169@ Common.kmg_common [INFO] run_one_cmd: total 584

-- シェルコマンド実行時のPIPEの情報が記載される --

2021-10-01 11:45:14,289@ Common.kmg_common [INFO] update_xml: The environment configuration check will start.
2021-10-01 11:45:30,090@ Common.kmg_common [INFO] update_xml: The environment configuration check is complete.
2021-10-01 11:45:30,093@ Common.kmg_common [INFO] create_xml_view: Start generating XML file for reference.
2021-10-01 11:45:31,288@ Common.kmg_common [INFO] update_file_full: ---- Update file ----
2021-10-01 11:45:31,290@ Common.kmg_common [INFO] update_file_full: ---- Success Update file ----
2021-10-01 11:45:31,291@ Common.kmg_common [INFO] create_xml_view: Complete generating XML file for reference.
2021-10-01 11:45:31,294@ Common.kmg_common [INFO] create_html: Start HTML file generation.
2021-10-01 11:45:31,359@ Common.kmg_common [INFO] create_html: End HTML file generation.
2021-10-01 11:45:31,365@ Common.kmg_common [INFO] update_file_full: ---- Update file ----
2021-10-01 11:45:31,368@ Common.kmg_common [INFO] update_file_full: ---- Success Update file ----
```
</br>
</br>

### **[2] How to edit the shell command file (.json)**
</br>
複数のシェルコマンドを収録したファイルを作成するためには、ツールに添付の「Jetson_to_do_001.json」を編集します。</br>
</br>
ファイル内の記載方法は次の通りです。</br>

---
**パターン１．** シェルコマンドを実行する場合の記述</br>
```
{"type":"cmd", "comment":"Execution [pip3 install]", "cmd":"sudo apt install python3-pip"}
```
* type : "cmd"　（実行形式をコマンド「cmd」に設定します。）　
* comment : "Execution [pip3 install]"　（ツール実行時ログへの表示名を指定します。)
* cmd : "sudo apt install python3-pip"　（実行するシェルコマンドを指定します。（例は「pip3」のインストール用コマンド）

---
**パターン２．** 指定したファイルの任意の行を置き換える場合</br>
```
{"type":"frc", "comment":"Execution [Update boot file]", "cmd":"/boot/config.txt", "original":"#dtparam=i2c_arm=on", "after":"dtparam=i2c_arm=on\nstart_x=1\n"}
```
* type : "frc"　（実行形式をコマンド「frc」に設定します。）　
* comment : "Execution [Update boot file]"　（ツール実行時ログへの表示名を指定します。)
* cmd : "cmd":"/boot/config.txt"　（編集するファイルの絶対パスを記載します。）
* original : "#dtparam=i2c_arm=on"　（置き換える元の行の文字列を記載します。）
* after : "dtparam=i2c_arm=on\nstart_x=1\n"　（置き換え後の行の文字列を記載します。）

---
**パターン３．** 指定したファイルの先頭行に任意の行を挿入する場合</br>
```
{"type":"ffc", "comment":"Execution [Update test file]", "cmd":"/boot/config.txt", "original":"", "after":"Insert first Line"}
```
* type : "ffc"　（実行形式をコマンド「ffc」に設定します。）　
* comment : "Execution [Update test file]"　（ツール実行時ログへの表示名を指定します。)
* cmd : "cmd":"/boot/config.txt"　（編集するファイルの絶対パスを記載します。）
* original : ""　（使用しません。）
* after : "Insert first Line"　（先頭行に挿入する文字列を記載します。）

---
**パターン４．** 指定したファイルの最終行に任意の行を追記する場合</br>
```
{"type":"fec", "comment":"Execution [Update test file]", "cmd":"/boot/config.txt", "original":"", "after":"Insert End Line"}
```
* type : "fec"　（実行形式をコマンド「fec」に設定します。）　
* comment : "Execution [Update test file]"　（ツール実行時ログへの表示名を指定します。)
* cmd : "cmd":"/boot/config.txt"　（編集するファイルの絶対パスを記載します。）
* original : ""　（使用しません。）
* after : "Insert End Line"　（最終行に追記する文字列を記載します。）
 </br>
</br>


以下のブログでこのツールを紹介しています。参考にしてください。（日本語）</br>
[【Jetson Nano】自分の記憶が信じられない貴方へ。。（セットアップ自動化）</br>https://karakuri-musha.com/inside-technology/jetson-pkg-management-tool/](https://karakuri-musha.com/inside-technology/jetson-pkg-management-tool/)

</br>
